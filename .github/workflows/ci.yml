name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
    steps:
      # 1️⃣ Checkout repo
      - uses: actions/checkout@v3

      # 2️⃣ Setup Node.js (NO YARN CACHE - let Corepack handle it)
      - uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3️⃣ Enable Corepack and set Yarn 4.0.2
      - name: ⚙️ Enable Corepack & Yarn 4
        run: |
          corepack enable
          corepack prepare yarn@4.0.2 --activate
          echo "✅ Yarn version: $(yarn --version)"

      # 4️⃣ Clear Yarn cache to fix corruption
      - name: 🧹 Clear Yarn cache
        run: |
          yarn cache clean
          rm -rf ~/.cache/yarn
          echo "✅ Yarn cache cleared"

      # 5️⃣ Install dependencies at root (workspace-aware)
      - name: 📦 Install Yarn dependencies
        run: yarn install --immutable

      # 6️⃣ Ensure @prisma/client matches schema
      - name: 🔧 Prisma Generate
        run: yarn workspace @sck/web prisma generate

      # 7️⃣ Install Sharp for Linux platform
      - name: 🖼️ Install Sharp (Linux)
        run: |
          cd apps/web
          npm install --platform=linux --arch=x64 sharp

      # 8️⃣ Build Next.js App
      - name: 🔨 Build Next.js
        run: yarn workspace @sck/web build

      # 9️⃣ Deploy to Vercel
      - name: 📦 Deploy to Vercel
        run: |
          echo "Deploying @sck/web to Vercel..."
          yarn workspace @sck/web vercel --prod --yes --token $VERCEL_TOKEN
