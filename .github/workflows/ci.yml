name: ğŸš€ SCK Platform CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  YARN_VERSION: '4.0.2'
  NODE_ENV: 'production'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # âœ… Enable Corepack FIRST (fixes the Yarn 1.x cache issue)
      - name: ğŸ”§ Enable Corepack & Yarn 4.0.2
        run: |
          corepack enable
          corepack prepare yarn@${{ env.YARN_VERSION }} --activate
          yarn --version

      - name: âš™ï¸ Setup Node.js & Yarn 4
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: â™»ï¸ Cache Yarn Dependencies
        uses: actions/cache@v3
        with:
          path: .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: ğŸ“¦ Install Dependencies
        run: yarn install --immutable

      - name: ğŸ”§ Prisma Generate
        run: yarn workspace @sck/web dlx prisma generate

      - name: ğŸ§ª Set Test Environment
        run: |
          echo "NEXT_PUBLIC_BASE_URL=http://localhost:3000" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_ENVIRONMENT=development" >> $GITHUB_ENV

      - name: ğŸ” Resolve Supabase DATABASE_URL
        run: |
          URL=""
          if [ -n "${{ secrets.DATABASE_URL }}" ]; then
            URL="${{ secrets.DATABASE_URL }}"
          elif [ -n "${{ secrets.SUPABASE_DATABASE_URL }}" ]; then
            URL="${{ secrets.SUPABASE_DATABASE_URL }}"
          elif [ -n "${{ secrets.SUPABASE_PRISMA_URL }}" ]; then
            URL="${{ secrets.SUPABASE_PRISMA_URL }}"
          elif [ -n "${{ secrets.POSTGRES_URL }}" ]; then
            URL="${{ secrets.POSTGRES_URL }}"
          else
            echo "âŒ Missing DATABASE_URL secret. Please set one of: DATABASE_URL, SUPABASE_DATABASE_URL, SUPABASE_PRISMA_URL, POSTGRES_URL" >&2
            exit 1
          fi
          if [[ "$URL" != *"sslmode="* ]]; then
            URL="${URL}?sslmode=require"
          fi
          echo "DATABASE_URL=$URL" >> $GITHUB_ENV
          echo "SHADOW_DATABASE_URL=$URL" >> $GITHUB_ENV

      - name: ğŸ—„ï¸ Run Prisma Migrations (Supabase)
        run: yarn workspace @sck/web dlx prisma migrate deploy

      - name: ğŸš€ Start Next.js Dev Server
        env:
          NODE_ENV: development
        run: |
          nohup yarn workspace @sck/web dev > /dev/null 2>&1 &
          npx wait-on http://localhost:3000

      - name: ğŸ” Type Check
        run: yarn workspace @sck/web type-check

      - name: ğŸ§¹ Lint Code
        run: yarn workspace @sck/web lint

      - name: ğŸ§ª Run Tests
        run: CI=true yarn workspace @sck/web test

      - name: ğŸ›‘ Stop Dev Server
        if: always()
        run: |
          pkill -f "next dev" || true

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # âœ… Enable Corepack FIRST (fixes the Yarn 1.x cache issue)
      - name: ğŸ”§ Enable Corepack & Yarn 4.0.2
        run: |
          corepack enable
          corepack prepare yarn@${{ env.YARN_VERSION }} --activate
          yarn --version

      - name: âš™ï¸ Setup Node.js & Yarn 4
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: â™»ï¸ Cache Yarn Dependencies
        uses: actions/cache@v3
        with:
          path: .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: ğŸ“¦ Install Dependencies
        run: yarn install --immutable

      - name: ğŸ”§ Prisma Generate
        run: yarn workspace @sck/web prisma generate

      - name: ğŸ”¨ Build Next.js App
        run: yarn workspace @sck/web build

      - name: ğŸ“¦ Deploy to Vercel
        run: yarn workspace @sck/web vercel --prod --yes --token ${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ENV: production

      - name: ğŸ¥ Health Check
        run: |
          echo "Waiting for deployment to complete..."
          sleep 30
          curl -f https://sck-plattform.vercel.app/api/v1/health || echo "âš ï¸ Health check failed - deployment may still be in progress"
