name: ğŸš€ SCK Platform CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  YARN_VERSION: '4.0.2'
  NODE_ENV: 'production'

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Enable Corepack & Yarn 4.0.2
        run: |
          corepack enable
          corepack prepare yarn@${{ env.YARN_VERSION }} --activate
          yarn --version

      - name: âš™ï¸ Setup Node.js & Yarn 4
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: â™»ï¸ Cache Yarn Dependencies
        uses: actions/cache@v3
        with:
          path: .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: ğŸ“¦ Install Dependencies
        run: yarn install --immutable

      - name: ğŸ”§ Prisma Generate
        run: yarn workspace @sck/web dlx prisma generate

      - name: ğŸ§ª Set Test Environment
        run: |
          echo "NEXT_PUBLIC_BASE_URL=http://localhost:3000" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_ENVIRONMENT=development" >> $GITHUB_ENV

      - name: ğŸ”— Link Vercel project (apps/web)
        working-directory: apps/web
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        run: |
          mkdir -p .vercel
          printf '{"projectId":"%s","orgId":"%s"}' "$VERCEL_PROJECT_ID" "$VERCEL_ORG_ID" > .vercel/project.json
          echo "ğŸ“„ Wrote apps/web/.vercel/project.json"
          yarn dlx vercel link --yes --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID" || true
          test -f .vercel/project.json && echo "âœ… Vercel project linked" || (echo "âŒ Missing .vercel/project.json" && exit 1)

      - name: ğŸŒ Pull environment from Vercel (preview)
        working-directory: apps/web
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          yarn dlx vercel env pull .env.ci --yes --environment=preview --token "$VERCEL_TOKEN"
          echo "âœ… Pulled env from Vercel into apps/web/.env.ci"
          
          # Debug: show what we actually got
          echo "ğŸ“‹ Preview env contents:"
          if [ -f .env.ci ]; then
            grep -E '^(DATABASE_URL|POSTGRES_|SUPABASE_)' .env.ci | head -10 || echo "No DB-related vars found"
          else
            echo "âŒ .env.ci file not created"
          fi

      - name: "ğŸŒ Fallback: Pull production env if DB missing"
        working-directory: apps/web
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          if ! grep -qE '^(DATABASE_URL|POSTGRES_PRISMA_URL|POSTGRES_URL|SUPABASE_PRISMA_URL|SUPABASE_DATABASE_URL)=' .env.ci; then
            echo "â„¹ï¸ No DB vars in preview env; pulling prod env"
            yarn dlx vercel env pull .env.prod --yes --environment=production --token "$VERCEL_TOKEN"
            while IFS= read -r line; do
              key="${line%%=*}"
              # If key missing or present with empty value, write/overwrite from prod
              if ! grep -qE "^${key}=" .env.ci; then
                echo "$line" >> .env.ci
              else
                cur=$(grep -E "^${key}=" .env.ci | head -n1)
                curv=${cur#*=}
                if [ -z "$curv" ]; then
                  # overwrite empty value with prod value
                  sed -i.bak -E "s#^${key}=.*#${line//\//\\/}#" .env.ci && rm -f .env.ci.bak
                fi
              fi
            done < .env.prod
            echo "âœ… Merged prod env into .env.ci"
          fi

      - name: "ğŸ”‘ Fallback: Use GitHub Secrets if Vercel env empty"
        working-directory: apps/web
        run: |
          if ! grep -qE '^(DATABASE_URL|POSTGRES_PRISMA_URL|POSTGRES_URL|SUPABASE_PRISMA_URL|SUPABASE_DATABASE_URL)=' .env.ci; then
            echo "âš ï¸ No DB vars from Vercel, trying GitHub Secrets fallback..."
            
            # Create .env.ci if it doesn't exist
            touch .env.ci
            
            # Add GitHub Secrets as fallback
            if [ -n "${{ secrets.DATABASE_URL }}" ]; then
              echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env.ci
              echo "âœ… Added DATABASE_URL from GitHub Secrets"
            fi
            
            if [ -n "${{ secrets.POSTGRES_PRISMA_URL }}" ]; then
              echo "POSTGRES_PRISMA_URL=${{ secrets.POSTGRES_PRISMA_URL }}" >> .env.ci
              echo "âœ… Added POSTGRES_PRISMA_URL from GitHub Secrets"
            fi
            
            if [ -n "${{ secrets.POSTGRES_URL }}" ]; then
              echo "POSTGRES_URL=${{ secrets.POSTGRES_URL }}" >> .env.ci
              echo "âœ… Added POSTGRES_URL from GitHub Secrets"
            fi
            
            if [ -n "${{ secrets.SUPABASE_PRISMA_URL }}" ]; then
              echo "SUPABASE_PRISMA_URL=${{ secrets.SUPABASE_PRISMA_URL }}" >> .env.ci
              echo "âœ… Added SUPABASE_PRISMA_URL from GitHub Secrets"
            fi
            
            if [ -n "${{ secrets.SUPABASE_DATABASE_URL }}" ]; then
              echo "SUPABASE_DATABASE_URL=${{ secrets.SUPABASE_DATABASE_URL }}" >> .env.ci
              echo "âœ… Added SUPABASE_DATABASE_URL from GitHub Secrets"
            fi
            
            echo "ğŸ“‹ Final env contents after GitHub Secrets fallback:"
            grep -E '^(DATABASE_URL|POSTGRES_|SUPABASE_)' .env.ci | head -10 || echo "Still no DB-related vars found"
          else
            echo "âœ… DB vars found in Vercel env, skipping GitHub Secrets fallback"
          fi

      - name: ğŸ” Normalize DATABASE_URL
        working-directory: apps/web
        run: |
          if [ ! -f .env.ci ]; then
            echo "âŒ .env.ci missing" >&2
            exit 1
          fi

          echo "ğŸ”‘ Pulled keys:" $(cut -d= -f1 .env.ci | tr '\n' ' ')

          set -a
          . ./.env.ci || true
          set +a

          # Try all possible DB URL sources
          DB="${DATABASE_URL:-${POSTGRES_PRISMA_URL:-${POSTGRES_URL:-${SUPABASE_PRISMA_URL:-${SUPABASE_DATABASE_URL:-}}}}}"
          DB=${DB%\"}; DB=${DB#\"}

          # Debug: show what we found
          if [ -n "$DB" ]; then
            echo "ğŸ” Found DB URL: $(echo "$DB" | sed -E 's#^(postgres(ql)?://)[^:]+:[^@]+@([^/?]+).*#\1***:***@\3#')"
          else
            echo "âš ï¸ No DB URL found in any source"
          fi

          if ! echo "$DB" | grep -Eq '^postgres(ql)?://'; then
            echo "âš ï¸ Invalid/missing DATABASE_URL, trying to reconstruct..."
            
            # Check if we have discrete vars
            if [ -n "$POSTGRES_HOST" ] && [ -n "$POSTGRES_USER" ] && [ -n "$POSTGRES_PASSWORD" ]; then
              USER="${POSTGRES_USER}"
              PASS="${POSTGRES_PASSWORD}"
              HOST="${POSTGRES_HOST}"
              PORT="${POSTGRES_PORT:-5432}"
              NAME="${POSTGRES_DATABASE:-postgres}"
              
              DB="postgresql://${USER}:${PASS}@${HOST}:${PORT}/${NAME}?sslmode=require"
              echo "âœ… Reconstructed DATABASE_URL with host=${HOST}, port=${PORT}, db=${NAME}"
            else
              echo "âŒ Cannot reconstruct DATABASE_URL - missing required vars:"
              echo "   POSTGRES_HOST: ${POSTGRES_HOST:-'missing'}"
              echo "   POSTGRES_USER: ${POSTGRES_USER:-'missing'}"
              echo "   POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-'missing'}"
              echo "   POSTGRES_DATABASE: ${POSTGRES_DATABASE:-'missing'}"
              echo "âš ï¸ Using PostgreSQL service for CI..."
              
              # Use GitHub Actions PostgreSQL service
              DB="postgresql://postgres:postgres@localhost:5432/postgres?sslmode=disable"
              echo "âœ… Using PostgreSQL service for CI"
            fi
          fi

          # Ensure a numeric port
          HOSTPART=$(echo "$DB" | sed -E 's#^postgres(ql)?://[^@]*@([^/:]+).*#\2#')
          PORTPART=$(echo "$DB" | sed -E 's#.*:([0-9]+)/.*#\1#;t;d')
          if [ -z "$PORTPART" ] || ! echo "$PORTPART" | grep -Eq '^[0-9]+$'; then
            DB=$(echo "$DB" | sed -E 's#(postgres(ql)?://[^@]*@[^/:]+)(:[^/]+)?#\1:5432#')
          fi

          echo "DB proto+host: $(echo "$DB" | sed -E 's#^(postgres(ql)?://)[^@]*@([^/?]+).*#\1\3#')"
          echo "DATABASE_URL=$DB" >> $GITHUB_ENV
          echo "SHADOW_DATABASE_URL=$DB" >> $GITHUB_ENV

      - name: ğŸ—„ï¸ Run Prisma Migrations
        run: yarn workspace @sck/web dlx prisma migrate deploy

      - name: ğŸš€ Start Next.js Dev Server
        env:
          NODE_ENV: development
        run: |
          nohup yarn workspace @sck/web dev > /dev/null 2>&1 &
          npx wait-on http://localhost:3000

      - name: ğŸ” Type Check
        run: yarn workspace @sck/web type-check

      - name: ğŸ§¹ Lint Code
        run: yarn workspace @sck/web lint

      - name: ğŸ§ª Run Tests
        run: CI=true yarn workspace @sck/web test

      - name: ğŸ›‘ Stop Dev Server
        if: always()
        run: pkill -f "next dev" || true

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Enable Corepack & Yarn 4.0.2
        run: |
          corepack enable
          corepack prepare yarn@${{ env.YARN_VERSION }} --activate
          yarn --version

      - name: âš™ï¸ Setup Node.js & Yarn 4
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: â™»ï¸ Cache Yarn Dependencies
        uses: actions/cache@v3
        with:
          path: .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: ğŸ“¦ Install Dependencies
        run: yarn install --immutable

      - name: ğŸ”§ Prisma Generate
        run: yarn workspace @sck/web prisma generate

      - name: ğŸ”¨ Build Next.js App
        run: yarn workspace @sck/web build

      - name: ğŸ“¦ Deploy to Vercel
        run: yarn workspace @sck/web vercel --prod --yes --token ${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ENV: production

      - name: ğŸ¥ Health Check
        run: |
          echo "Waiting for deployment..."
          sleep 30
          curl -f https://sck-plattform.vercel.app/api/v1/health || echo "âš ï¸ Health check failed"