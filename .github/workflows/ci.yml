name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      NODE_ENV: production
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
    steps:
      # 1ï¸âƒ£ Checkout repo
      - uses: actions/checkout@v3

      # 2ï¸âƒ£ Setup Node.js (NO YARN CACHE - let Corepack handle it)
      - uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3ï¸âƒ£ Enable Corepack and set Yarn 4.0.2
      - name: âš™ï¸ Enable Corepack & Yarn 4
        run: |
          corepack enable
          corepack prepare yarn@4.0.2 --activate
          echo "âœ… Yarn version: $(yarn --version)"

      # 4ï¸âƒ£ Clear Yarn cache to fix corruption
      - name: ğŸ§¹ Clear Yarn cache
        run: |
          yarn cache clean
          rm -rf ~/.cache/yarn
          echo "âœ… Yarn cache cleared"

      # 5ï¸âƒ£ Install dependencies at root (workspace-aware)
      - name: ğŸ“¦ Install Yarn dependencies
        run: yarn install --immutable

      # 6ï¸âƒ£ Ensure @prisma/client matches schema
      - name: ğŸ”§ Prisma Generate
        run: yarn workspace @sck/web prisma generate

      # 7ï¸âƒ£ Install Sharp for Linux platform
      - name: ğŸ–¼ï¸ Install Sharp (Linux)
        run: |
          cd apps/web
          npm install --platform=linux --arch=x64 sharp

      # 8ï¸âƒ£ Build Next.js App
      - name: ğŸ”¨ Build Next.js
        run: yarn workspace @sck/web build

      # 9ï¸âƒ£ Deploy to Vercel
      - name: ğŸ“¦ Deploy to Vercel
        run: |
          echo "Deploying @sck/web to Vercel..."
          yarn workspace @sck/web vercel --prod --yes --token $VERCEL_TOKEN
